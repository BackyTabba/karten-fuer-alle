<html>
<head>
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin=""> -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script> -->

    <!-- leaflet-toolbar -->
	<link rel="stylesheet" type="text/css" href="/node_modules/leaflet/dist/leaflet.css" />
	<link rel="stylesheet" type="text/css" href="/node_modules/leaflet-draw/dist/leaflet.draw.css" />
	<link rel="stylesheet" type="text/css" href="/node_modules/leaflet-toolbar/dist/leaflet.toolbar.css" />
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"/>
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css"/>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"/>	
    <link rel="stylesheet" href="/node_modules/leaflet-draw-toolbar/dist/leaflet.draw-toolbar.css"/>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="/node_modules/leaflet/dist/leaflet-src.js"></script>
	<script src="/node_modules/leaflet-toolbar/dist/leaflet.toolbar-src.js"></script>
	<script src="/node_modules/leaflet-draw/dist/leaflet.draw-src.js"></script>
    <script src="/node_modules/leaflet-draw-toolbar/dist/leaflet.draw-toolbar.js"></script>
	<script src="ColorPicker.js"></script>
	<script src="/node_modules/leaflet-providers/leaflet-providers.js"></script>
	<script src="/node_modules/socket.io/client-dist/socket.io.js"></script>
	<style>
			.another-popup .leaflet-popup-content-wrapper {
		font-size: 24px;
		line-height: 24px;
		border-radius: 0px;
}
		</style>
<script>
  var socket = io();

  //_________________________________________________
//class="fa fa-list"


EditFromDB = L.Toolbar2.Action.extend({
	options: {
		toolbarIcon: { className: 'fa fa-list' }
	},

	initialize: function (map, shape, options) {
		this._map = map;

		this._shape = shape;

		L.Toolbar2.Action.prototype.initialize.call(this, map, options);
	},

	enable: function () {
		var map = this._map,
			shape = this._shape;

		//shape.bindPopup()
		//shape.Popup
		popupstring2="";
		$.ajax(  {method:"Get",
  			url:"http:\/\/localhost:3000/schema"}).done((data)=>{
				console.log(data);
				outstr='<div><select name="DomainOperations" id="DomainOperations">\n'
				for(x of data){
					console.log(x.wert)
					outstr+='"<option value="'+x.wert+'">'+x.wert+'</option>+\n'
				}
				outstr+='</select>\n <input type="submit" value="Senden"></div>'
				shape._popup._content+=outstr;
				shape._popup.update()
				shape._popup._
			})
		popupstring='<div><label for="text1">Erstes Attribut </label><input type="text" id="text1" name="text1" value="text1"></div>'
		popupstring+='<div><label for="text2">Zweites Attribut </label><input type="text" id="text2" name="text2" value="text2"></p></div>'
		
		console.log(popupstring2)
		shape.bindPopup(popupstring,{"className":"another-popup"});
		console.log(shape)
		console.log(shape._eventParents[Object.keys(shape._eventParents)[0]].RealID)
		//.setContent('<p>Hello world!<br />This is a nice popup.</p>')
		map.removeLayer(this.toolbar);
		
		map.on('click', function () {
			this.save();
			//shape.editing.disable();
			shape.popup.disable();
		}, this);
	},

	save: function() {
		var map = this._map,
			shape = this._shape;

		//if (shape.edited) {
			//mit Fire Popup austauschen
			//map.fire(L.Draw.Event.EDITED, { layers: L.layerGroup([shape]) });
		//}
		//shape.edited = false;
	}
});

//______________________________
</script>
	<!-- <script src="/node_modules/file-dialog/file-dialog.min.js"></script> -->
	<!-- <script src="/node_modules/FileSaver/FileSaver.js"></script> -->
<style>
    html, body, #map { margin: 0; height: 100%; width: 100%; flex-flow:row}
	.fantasyclass{
		position: absolute;
		top: 0;
		right: 0;
	}
	.overlay{
		position: absolute;
		top: 12px;
		left: 100px;
		z-index: 410;
		background-color: #fff;
		font-size: 18px;
		border-radius: 2px;
		padding: 0px 10px;

	}
</style>
<body onload="OnMapLoad()"> 
<div id="map">
	<div class="overlay">Tool-Ãœberschrift lalala</div>
</div>
<input type="file" id="load-file" style="display:none" >
<!--%0A neue Zeile; %2C Komma  encodeURI   accept=".geojson"-->
<style>
		 .leaflet-toolbar-icon .fa { color: rgb(74, 74, 74);
            font-size: 0.9rem;} 
		.leaflet-color-swatch { background-color: #fff
        }
        .leaflet-retina .leaflet-draw-toolbar.leaflet-draw-toolbar a{
            display: flex; 
            align-items: center;
            justify-content: center; 
            }
		.leaflet-control-layers-base{
			font-size: 15px;
		}
</style>
<script>
	//toolbar zu klein: https://stackoverflow.com/questions/56792059/which-leaflet-library-or-workaround-to-control-toolbar-size
	//blurry Maps https://github.com/Leaflet/Leaflet/issues/6068
/*var map = L.map('map').setView([51.505, -0.09], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);*/
var latlng = L.latLng(51.508530,-0.076132);
/*
var tooltip = L.tooltip(latlng, {content: 'Hello world!<br />This is a nice tooltip.'})
    .addTo(map);*/

    //leaflet-toolbar
	console.log()
	var baseMaps = {
		"OpenTest": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
      }),
		"Testmap1": L.tileLayer.provider("CartoDB.Positron"),
		"Testmap2": L.tileLayer.provider("CartoDB.DarkMatter"),
		"Testmap3": L.tileLayer.provider("CartoDB.Voyager"),
		"OpenStreetMap Mapnik": L.tileLayer.provider("OpenStreetMap.Mapnik"),
		"OpenTopoMap": L.tileLayer.provider("OpenTopoMap"),
		"Stadia AlidadeSmoothDark": L.tileLayer.provider("Stadia.AlidadeSmoothDark"),
		"Stadia OSMBright": L.tileLayer.provider("Stadia.OSMBright"),
		"Esri World Imagery":L.tileLayer.provider('Esri.WorldImagery')

	};
	IOactions=[]
	
    var map = L.map('map',{layers:baseMaps["OpenStreetMap Mapnik"]}).setView([41.7896,-87.5996], 15),
			drawnItems = new L.FeatureGroup().addTo(map),
			editActions = [
                L.Toolbar2.EditAction.Popup.Edit,
                L.Toolbar2.EditAction.Popup.Delete,
				EditFromDB,
				L.Toolbar2.Action.extendOptions({
					toolbarIcon: { 
						className: 'leaflet-color-picker', 
						html: '<span class="fa fa-eyedropper"></span>' 
					},
					subToolbar: new L.Toolbar2({ actions: [
						L.ColorPicker.extendOptions({ color: '#db1d0f' }),
						L.ColorPicker.extendOptions({ color: '#025100' }),
						L.ColorPicker.extendOptions({ color: '#ffff00' }),
						L.ColorPicker.extendOptions({ color: '#0000ff' }),
                        L.ColorPicker.extendOptions({ color: "#3388ff" })
					]})
				})
			];
	drawnItems.getLayerByRealID=function(RealID){
		for (x of drawnItems.getLayers()){
			if(x["_layers"] == undefined){
				if(x.getRealID()==RealID){
					return x;
				}
			}
		}
	}

	function AddToMap(data){
		for (x of data) {
			console.log("x",x,"data",data,"data[x]",data[x])
			layer=L.geoJSON(JSON.parse(x.object),{
				onEachFeature: function (feature, layer) {
					layer.on('click', function (event) {
					new L.Toolbar2.EditToolbar.Popup(event.latlng, {
						actions: editActions
					}).addTo(map, layer);});
					layer.on("edit", function(evt) {
						layer = evt.target;
						$.ajax({
						type: "POST",
						url: "http:\/\/localhost:3000/upload",
						data: {"content":JSON.stringify(layer.toGeoJSON()),"_id":layer.RealID},
						success: console.log("Successful transmitted Edit of id:"+layer.RealID+"!")
						});	})
					layer.on('click', function(event) {
						new L.Toolbar2.EditToolbar.Popup(event.latlng, {
							actions: editActions
						}).addTo(map, layer);
					})
				}
			})
			layer.RealID=x._id;
			layer.getRealID=function(){return layer.LayerID};
			layer.addTo(map);
			drawnItems.addLayer(layer);
		}
	}
	map.on("draw:deleted",(evt)=>{console.log("MAP: Now we could send delete post",evt)
				console.log("RealID",evt.layers.getLayers()[0].RealID)
				console.log(evt.layers.getLayers())
				layer=evt.layers.getLayers()[0];
				$.ajax({
					type: "DELETE",
					url: "http:\/\/localhost:3000/upload",
					data: {"_id":layer.RealID},
					success: console.log("Successful transmitted Delete of id:"+layer.RealID+"!")
				});	
			})
	function OnMapLoad(){
		console.log("load fired")
		$.ajax({
			type: "GET",
			url: "http:\/\/localhost:3000/upload",
			success: console.log("Successful transmitted Get of all!")
		}).done((data)=>{
			console.log(data);
			AddToMap(data);
		});
	}
		var layerControl = L.control.layers(baseMaps).addTo(map);

		new L.Toolbar2.DrawToolbar({
			position: 'topleft',
            actions:[L.Toolbar2.DrawAction.Polygon,
                    L.Toolbar2.DrawAction.Polyline,
                    L.Toolbar2.DrawAction.Marker,
					L.Toolbar2.DrawAction.Rectangle,
					L.Toolbar2.DrawAction.Circle
                ],
		}).addTo(map);
        //var toolbar = new L.Toolbar2.DrawToolbar(); // empty toolbar
        
		var saveGeojson = L.Toolbar2.Action.extend({
				options: {
					toolbarIcon: { 
						//    &#128190; &#128427; &#x1F5AB; &#9873; &#128194; file folder https://www.compart.com/en/unicode/U+1F4C2
						html: '&#x1F5AB;',
						tooltip: 'Get GeoJson'
					},
					
				},

				addHooks: function () {

					console.log(JSON.stringify(drawnItems.toGeoJSON()));
					var toSave = encodeURIComponent(JSON.stringify(drawnItems.toGeoJSON()));
					console.log('toSave',toSave);
					//window.open("data:application/octet-stream,"+toSave,"_blank");
					window.open("data:application/octet-stream,"+toSave,"_blank");
					fileDialog({ multiple: false, accept: 'image/*' }, files => {
						//files contains an array of FileList
					})
				}

			});
			var openGeojson = L.Toolbar2.Action.extend({
				options: {
					toolbarIcon: { 
						//    &#128190; &#128427; &#x1F5AB; &#9873; &#128194; file folder https://www.compart.com/en/unicode/U+1F4C2				
						html: '&#128194',
						tooltip: 'Upload GeoJson'
					},
				},
				addHooks: function () {
					console.log("L.geoJSON(JSON(temp0)).addTo(map)");
					document.getElementById("load-file").click();
					document.getElementById("load-file").addEventListener("change",function(){
						var fr = new FileReader();
						fr.onload=function(){
							console.log(fr.result);
							console.log(JSON.parse(fr.result));
							layer=L.geoJSON(JSON.parse(fr.result),{onEachFeature: function (feature, layer) {
								layer.on('click', function (event) {
								new L.Toolbar2.EditToolbar.Popup(event.latlng, {
									actions: editActions
								}).addTo(map, layer);
							})
							}});
							layer.addTo(map);
							drawnItems.addLayer(layer);
						}
						fr.readAsText(this.files[0])
					})
				}
			});
			
			IOactions=[...IOactions,openGeojson]
			IOactions=[...IOactions,saveGeojson]
			new L.Toolbar2.Control({
				position: 'topleft',
				actions: IOactions
			}).addTo(map);
/*
	const pickerOpts = {
		types: [
			{
				description: 'Images',
				accept: {
					'image/*': ['.png', '.gif', '.jpeg', '.jpg']
				}
			},
		],
		excludeAcceptAllOption: true,
		multiple: false
	};

	async function getTheFile() {
		// open file picker
		[fileHandle] = await window.showOpenFilePicker(pickerOpts);

		// get file contents
		const fileData = await fileHandle.getFile();
	}

	getTheFile();

			function readSingleFile(e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				var reader = new FileReader();
				reader.onload = function (e) {
					var contents = e.target.result;
					console.log(contents);
				};
				reader.readAsText(file);
			}
			readSingleFile();*/

	/*socket.on("init",(data)=>{
		layer=L.geoJSON(JSON.parse(data.object),{
			onEachFeature: function (feature, layer) {
				layer.RealID=data._id;
				layer.getRealID=function(){return this.LayerID};
				layer.on('click', function (event) {
				new L.Toolbar2.EditToolbar.Popup(event.latlng, {
					actions: editActions
				}).addTo(map, layer);});
				layer.on("edit", function(evt) {
					layer = evt.target;
					$.ajax({
					type: "POST",
					url: "http:\/\/localhost:3000/upload",
					data: {"content":JSON.stringify(layer.toGeoJSON()),"_id":layer.RealID},
					success: console.log("Successful transmitted Edit of id:"+layer.RealID+"!")
					});	})
				layer.on('click', function(event) {
					new L.Toolbar2.EditToolbar.Popup(event.latlng, {
						actions: editActions
					}).addTo(map, layer);
				})
			}
		})
		layer.addTo(map);
		drawnItems.addLayer(layer);
	})*/
	socket.on("update",(data)=>{console.log("data from socket",data)
		console.log("data._id",data._id)
		console.log(drawnItems.getLayerByRealID(data._id));
		currentLayer=drawnItems.getLayerByRealID(data._id);
		drawnItems.removeLayer(currentLayer);
		map.removeLayer(currentLayer);
		drawnItems.removeLayer(currentLayer);
		AddToMap(data);
		/*
			console.log(data.object)
		layer=L.geoJSON(JSON.parse(data.object),{
			onEachFeature: function (feature, layer) {
				layer.RealID=data._id;
				layer.getRealID=function(){return this.LayerID};
				layer.on('click', function (event) {
				new L.Toolbar2.EditToolbar.Popup(event.latlng, {
					actions: editActions
				}).addTo(map, layer);});
				layer.on("edit", function(evt) {
					layer = evt.target;
					$.ajax({
					type: "POST",
					url: "http:\/\/localhost:3000/upload",
					data: {"content":JSON.stringify(layer.toGeoJSON()),"_id":layer.RealID},
					success: console.log("Successful transmitted Edit of id:"+layer.RealID+"!")
					});	})
				layer.on('click', function(event) {
					new L.Toolbar2.EditToolbar.Popup(event.latlng, {
						actions: editActions
					}).addTo(map, layer);
				})
			}
		})
		layer.addTo(map);
		drawnItems.addLayer(layer);*/
	});

			//websockets https://socket.io/get-started/chat
	map.on('draw:created', function(evt) {
		console.log("DRAW CREATED!!!")
		var	type = evt.layerType,
		layer = evt.layer;
				
		L.stamp(layer);
		id=drawnItems.getLayerId(evt);
		layer.RealID=id;
		layer.getRealID=function(){return this.LayerID};
		console.log("RealID",layer.RealID);
		$.ajax({
			type: "POST",
			url: "http:\/\/localhost:3000/upload",
			data: {"content":JSON.stringify(evt.layer.toGeoJSON()),"_id":layer.RealID},
			success: console.log("Successful transmitted Creation of id:"+layer.RealID+"!")
		});
						//https://gis.stackexchange.com/questions/171648/how-get-layerid-or-layer-name-from-marker
		layer.on("edit", function(evt) {
			layer = evt.target;
			$.ajax({
				type: "POST",
				url: "http:\/\/localhost:3000/upload",
				data: {"content":JSON.stringify(layer.toGeoJSON()),"_id":layer.RealID},
				success: console.log("Successful transmitted Edit of id:"+layer.RealID+"!")
			});	
		});
		layer.on('click', function(event) {
			new L.Toolbar2.EditToolbar.Popup(event.latlng, {
				actions: editActions
			}).addTo(map, layer);
		});
		drawnItems.addLayer(layer);
		/*map.on("draw:deleted",(evt)=>{console.log("MAP: Now we could send delete post",evt)
			console.log("RealID",evt.layers.getLayers()[0].RealID)
			console.log(evt.layers.getLayers())
			layer=evt.layers.getLayers()[0];
			$.ajax({
				type: "DELETE",
				url: "http:\/\/localhost:3000/upload",
				data: {"_id":layer.RealID},
				success: console.log("Successful transmitted Delete of id:"+layer.RealID+"!")
			});	
		})*/	

	});






</script>
</body>
	  
</html>